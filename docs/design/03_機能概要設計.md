# 医療カルテシステム 機能概要設計

## 1. システム全体構成

### 1.1 システム構成図

```
┌─────────────────────────────────────────────────────────┐
│                    患者ポータル                          │
│              (Patient Portal Web/Mobile)                │
└──────────────────┬──────────────────────────────────────┘
                   │
┌──────────────────┴──────────────────────────────────────┐
│                  外部システム連携層                       │
│  ・地域医療連携    ・電子処方箋    ・レセプトオンライン  │
└──────────────────┬──────────────────────────────────────┘
                   │
┌──────────────────┴──────────────────────────────────────┐
│              医療カルテシステム（本体）                   │
│  ┌─────────────────────────────────────────────────┐  │
│  │           フロントエンド（Web UI）                 │  │
│  │  ・医師用  ・看護師用  ・事務用  ・薬剤師用       │  │
│  └───────────────────┬─────────────────────────────┘  │
│                      │                                   │
│  ┌───────────────────┴─────────────────────────────┐  │
│  │           アプリケーション層（API）                │  │
│  │  ・認証認可  ・診療管理  ・オーダー管理           │  │
│  │  ・予約管理  ・会計管理  ・レポート生成           │  │
│  └───────────────────┬─────────────────────────────┘  │
│                      │                                   │
│  ┌───────────────────┴─────────────────────────────┐  │
│  │              データベース層                        │  │
│  │  ・PostgreSQL（メインDB） ・Redis（キャッシュ）   │  │
│  └─────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────┘
                   │
┌──────────────────┴──────────────────────────────────────┐
│                  医療機器・システム連携                   │
│  ・PACS  ・検査システム  ・医療機器  ・バイタル機器      │
└─────────────────────────────────────────────────────────┘
```

### 1.2 アーキテクチャパターン

- **フロントエンド**: SPA（Single Page Application）- React/Vue.js
- **バックエンド**: RESTful API + WebSocket（リアルタイム通知）
- **認証**: OAuth 2.0 + JWT + 二要素認証
- **データベース**: PostgreSQL（メイン） + Redis（セッション・キャッシュ）
- **ファイルストレージ**: S3互換オブジェクトストレージ（画像・PDF等）

## 2. 機能一覧

### 2.1 患者管理機能群

#### 2.1.1 患者登録・管理
- **機能ID**: F-PAT-001
- **概要**: 患者の基本情報を登録・更新・検索
- **主要機能**:
  - 新規患者登録（初診受付）
  - 患者情報更新（住所変更、連絡先変更等）
  - 患者検索（氏名カナ、生年月日、患者番号）
  - 患者情報閲覧（基本情報、保険情報）
  - 患者マージ（重複患者の統合）
- **権限**: 医療事務、医師、看護師（閲覧のみ）
- **関連テーブル**: Patient, PatientInsurance

#### 2.1.2 アレルギー・既往歴管理
- **機能ID**: F-PAT-002
- **概要**: 患者のアレルギー情報、既往歴を管理
- **主要機能**:
  - アレルギー情報登録・更新
  - 既往歴登録・更新
  - 家族歴登録・更新
  - アレルギーアラート表示（処方時）
- **権限**: 医師、看護師
- **関連テーブル**: PatientAllergy, PatientMedicalHistory, PatientFamilyHistory

#### 2.1.3 患者保険情報管理
- **機能ID**: F-PAT-003
- **概要**: 患者の保険証情報を管理
- **主要機能**:
  - 保険証情報登録
  - 保険証画像スキャン・保存
  - 保険資格確認（オンライン資格確認）
  - 保険証有効期限アラート
- **権限**: 医療事務
- **関連テーブル**: PatientInsurance

### 2.2 診療管理機能群

#### 2.2.1 受付・来院登録
- **機能ID**: F-MED-001
- **概要**: 患者来院時の受付処理
- **主要機能**:
  - 来院受付登録
  - 予約確認・紐付け
  - 問診票入力
  - 診療科・担当医割り当て
  - 待合室管理
- **権限**: 医療事務
- **関連テーブル**: Visit, Appointment, WaitingQueue

#### 2.2.2 カルテ記録
- **機能ID**: F-MED-002
- **概要**: 診療記録の作成・管理（SOAPフォーマット）
- **主要機能**:
  - カルテ新規作成
  - SOAP入力（S: 自覚症状、O: 他覚所見、A: 評価、P: 計画）
  - フリーテキスト入力
  - テンプレート使用（定型文）
  - 音声入力対応
  - 画像・ファイル添付
  - カルテ閲覧（過去履歴）
  - カルテ検索（全文検索）
  - 電子署名
  - カルテ履歴表示
- **権限**: 医師、看護師（補助記録のみ）
- **関連テーブル**: MedicalRecord, MedicalRecordHistory

#### 2.2.3 診断・病名登録
- **機能ID**: F-MED-003
- **概要**: 診断名（傷病名）の登録・管理
- **主要機能**:
  - 病名検索（ICD-10コード）
  - 病名登録（主病名、副病名、疑い病名）
  - 発症日・転帰入力
  - 慢性疾患フラグ設定
  - 病名一覧表示
- **権限**: 医師
- **関連テーブル**: Diagnosis, Disease

#### 2.2.4 バイタルサイン記録
- **機能ID**: F-MED-004
- **概要**: バイタルサインの測定・記録
- **主要機能**:
  - バイタル測定値入力（体温、血圧、脈拍、SpO2等）
  - 医療機器からの自動取り込み
  - 異常値アラート
  - バイタルグラフ表示（時系列）
  - BMI自動計算
- **権限**: 看護師、医師
- **関連テーブル**: VitalSign

### 2.3 オーダー管理機能群

#### 2.3.1 処方オーダー
- **機能ID**: F-ORD-001
- **概要**: 処方箋の発行・管理
- **主要機能**:
  - 処方薬検索（薬剤名、成分名）
  - 処方入力（用法、用量、日数）
  - セット処方（定型処方）
  - 処方チェック機能:
    - アレルギーチェック
    - 薬剤相互作用チェック
    - 重複投薬チェック
    - 投与量適正チェック
    - 保険適用チェック
  - 処方箋出力（院内・院外）
  - 薬剤師による処方確認
  - 調剤完了記録
- **権限**: 医師（処方）、薬剤師（確認・調剤）
- **関連テーブル**: PrescriptionOrder, PrescriptionDetail, Medication

#### 2.3.2 検査オーダー
- **機能ID**: F-ORD-002
- **概要**: 臨床検査の依頼・結果管理
- **主要機能**:
  - 検査項目検索・選択
  - セット検査登録
  - 検査オーダー発行
  - 至急フラグ設定
  - 検査結果入力
  - 異常値アラート
  - 検査結果グラフ表示（経時変化）
  - 検査結果レポート出力
- **権限**: 医師（オーダー）、検査技師（結果入力）
- **関連テーブル**: LabOrder, LabResult, LabTest

#### 2.3.3 画像検査オーダー
- **機能ID**: F-ORD-003
- **概要**: 画像検査（X線、CT、MRI等）の依頼・管理
- **主要機能**:
  - 画像検査オーダー発行
  - 検査部位・目的指定
  - PACS連携（画像取り込み）
  - 画像ビューア表示
  - 読影レポート入力
  - 過去画像との比較表示
- **権限**: 医師、放射線技師
- **関連テーブル**: ImagingOrder, ImagingResult

### 2.4 入院管理機能群

#### 2.4.1 入院管理
- **機能ID**: F-ADM-001
- **概要**: 入院手続き・管理
- **主要機能**:
  - 入院予約登録
  - 入院受付
  - 病床割り当て
  - 入院計画書作成
  - 病床移動
  - 退院手続き
  - 退院サマリー作成
- **権限**: 医療事務、医師、看護師
- **関連テーブル**: Admission, Bed

#### 2.4.2 看護記録
- **機能ID**: F-ADM-002
- **概要**: 看護記録の作成・管理
- **主要機能**:
  - 看護記録入力
  - バイタルサイン記録
  - 投薬実施記録
  - 医師指示受け・実施記録
  - 看護サマリー作成
- **権限**: 看護師
- **関連テーブル**: NursingRecord, MedicationAdministration

### 2.5 予約管理機能群

#### 2.5.1 診療予約
- **機能ID**: F-APP-001
- **概要**: 診療予約の受付・管理
- **主要機能**:
  - 予約枠設定（診療科・医師別）
  - 予約受付（電話、窓口、オンライン）
  - 予約空き枠検索
  - 予約変更・キャンセル
  - 予約リマインダー送信（メール・SMS）
  - 予約一覧表示（カレンダー形式）
  - 来院確認
  - 無断キャンセル記録
- **権限**: 医療事務、患者（オンライン予約）
- **関連テーブル**: Appointment, Schedule

### 2.6 医事会計機能群

#### 2.6.1 会計処理
- **機能ID**: F-BIL-001
- **概要**: 診療費の計算・会計
- **主要機能**:
  - 診療報酬点数自動計算
  - 保険負担割合計算
  - 患者負担額計算
  - 領収書発行
  - 会計明細表示
  - 未収金管理
  - 支払記録
  - 返金処理
- **権限**: 医療事務
- **関連テーブル**: Billing, BillingDetail, Payment

#### 2.6.2 レセプト請求
- **機能ID**: F-BIL-002
- **概要**: 診療報酬請求（レセプト）の作成・送信
- **主要機能**:
  - レセプトデータ作成
  - レセプトチェック（縦覧点検、突合点検）
  - レセプト電子データ出力
  - オンライン請求送信
  - 返戻・査定管理
  - 再請求処理
- **権限**: 医療事務、管理者
- **関連テーブル**: Billing, BillingDetail

### 2.7 システム管理機能群

#### 2.7.1 ユーザー・権限管理
- **機能ID**: F-SYS-001
- **概要**: システムユーザーの管理
- **主要機能**:
  - ユーザー登録・更新・削除
  - パスワード管理
  - ロール・権限設定
  - アクセス権限管理
  - 二要素認証設定
  - ログイン履歴確認
- **権限**: システム管理者
- **関連テーブル**: User, Role, Staff

#### 2.7.2 マスタ管理
- **機能ID**: F-SYS-002
- **概要**: 各種マスタデータの管理
- **主要機能**:
  - 診療科マスタ管理
  - 職員マスタ管理
  - 薬剤マスタ管理
  - 検査項目マスタ管理
  - 病名マスタ管理（ICD-10）
  - 診療報酬マスタ管理
  - 施設情報管理
- **権限**: システム管理者、医療事務
- **関連テーブル**: Department, Staff, Medication, LabTest, Disease, MedicalFeeItem, Facility

#### 2.7.3 監査ログ・セキュリティ
- **機能ID**: F-SYS-003
- **概要**: システム操作ログの記録・監査
- **主要機能**:
  - 操作ログ記録（全アクセス）
  - ログ検索・閲覧
  - 患者情報アクセスログ
  - 不正アクセス検知
  - セキュリティアラート
  - ログエクスポート
- **権限**: システム管理者、監査担当者
- **関連テーブル**: AuditLog

#### 2.7.4 バックアップ・リカバリ
- **機能ID**: F-SYS-004
- **概要**: データバックアップ・復旧
- **主要機能**:
  - 自動バックアップスケジュール設定
  - 手動バックアップ実行
  - バックアップ状態確認
  - データリストア
  - 災害対策（DR）機能
- **権限**: システム管理者
- **関連テーブル**: 全テーブル

### 2.8 レポート・分析機能群

#### 2.8.1 各種帳票出力
- **機能ID**: F-REP-001
- **概要**: 診療に関する各種帳票の出力
- **主要機能**:
  - 診療明細書
  - 処方箋
  - 検査結果レポート
  - 診断書
  - 紹介状
  - 入院計画書
  - 退院サマリー
  - 看護サマリー
- **権限**: 医師、看護師、医療事務
- **関連テーブル**: 各種テーブル

#### 2.8.2 統計・分析
- **機能ID**: F-REP-002
- **概要**: 診療データの統計分析
- **主要機能**:
  - 診療統計（患者数、診療科別等）
  - 疾患統計（病名別患者数等）
  - 収益分析（診療報酬分析）
  - 薬剤使用統計
  - 検査統計
  - ダッシュボード表示
  - レポートエクスポート（CSV、Excel）
- **権限**: 管理者、医師
- **関連テーブル**: 各種テーブル

### 2.9 患者ポータル機能群

#### 2.9.1 患者向けWebサービス
- **機能ID**: F-PTL-001
- **概要**: 患者自身がアクセスできるポータルサイト
- **主要機能**:
  - オンライン予約
  - 診療予約確認・変更
  - 検査結果閲覧
  - 処方内容確認
  - 診療費確認
  - 問診票入力
  - 診療履歴閲覧
  - お薬手帳連携
- **権限**: 患者本人（認証済み）
- **関連テーブル**: Patient, Appointment, LabResult, PrescriptionOrder, Billing

## 3. 機能間連携フロー

### 3.1 外来診療フロー（機能連携）

```
[受付] F-MED-001 来院登録
  ↓
[問診] F-PAT-002 既往歴・アレルギー確認
  ↓
[診察前] F-MED-004 バイタル測定
  ↓
[診察] F-MED-002 カルテ記録
  ├─ F-MED-003 診断登録
  ├─ F-ORD-001 処方オーダー（自動チェック）
  ├─ F-ORD-002 検査オーダー
  └─ F-APP-001 次回予約
  ↓
[薬剤] F-ORD-001 処方確認・調剤
  ↓
[会計] F-BIL-001 診療費計算・会計
  ↓
[月次] F-BIL-002 レセプト請求
```

### 3.2 入院診療フロー（機能連携）

```
[入院決定] F-ADM-001 入院予約
  ↓
[入院当日] F-ADM-001 入院受付・病床割当
  ↓
[入院中]
  ├─ F-MED-002 カルテ記録（回診）
  ├─ F-ADM-002 看護記録
  ├─ F-MED-004 バイタル測定
  ├─ F-ORD-001 処方・投薬
  ├─ F-ORD-002 検査
  └─ F-ADM-002 投薬実施記録
  ↓
[退院] F-ADM-001 退院手続き
  ├─ F-REP-001 退院サマリー作成
  └─ F-BIL-001 退院会計
```

## 4. 非機能要件

### 4.1 パフォーマンス要件

| 項目 | 要件 |
|------|------|
| 画面表示応答時間 | 2秒以内（通常操作） |
| 検索処理 | 3秒以内（通常検索）、10秒以内（全文検索） |
| 同時接続ユーザー数 | 100ユーザー以上 |
| データベースレスポンス | 1秒以内（単純クエリ）、5秒以内（複雑クエリ） |
| バックアップ時間 | 診療時間外に完了 |

### 4.2 可用性要件

| 項目 | 要件 |
|------|------|
| 稼働率 | 99.9%以上（月間ダウンタイム43分以内） |
| 計画停止 | 月1回、診療時間外のみ |
| 障害復旧時間（RTO） | 4時間以内 |
| データ復旧ポイント（RPO） | 1時間以内 |

### 4.3 セキュリティ要件

| 項目 | 要件 |
|------|------|
| 認証 | ID/パスワード + 二要素認証 |
| 通信暗号化 | TLS 1.3 |
| データ暗号化 | 個人情報はAES-256暗号化 |
| アクセス制御 | ロールベースアクセス制御（RBAC） |
| 監査ログ | 全操作ログ記録、7年保存 |
| パスワードポリシー | 8文字以上、英数字記号混在、90日更新 |

### 4.4 保守性・運用性

| 項目 | 要件 |
|------|------|
| ログレベル | DEBUG/INFO/WARN/ERROR |
| エラー通知 | システム管理者に自動通知 |
| データベースメンテナンス | 週次でVACUUM、月次でREINDEX |
| バージョン管理 | Git使用、タグ付けリリース |
| ドキュメント | 設計書、運用手順書、障害対応手順書 |

### 4.5 拡張性・互換性

| 項目 | 要件 |
|------|------|
| 患者数 | 100万人まで対応 |
| 年間来院数 | 100万件まで対応 |
| 多施設対応 | 将来的に複数施設統合可能な設計 |
| API公開 | 外部システム連携用REST API提供 |
| HL7対応 | HL7 FHIR準拠のデータ交換 |
| 標準コード | ICD-10、YJコード、診療報酬コード準拠 |

### 4.6 ユーザビリティ

| 項目 | 要件 |
|------|------|
| 画面デザイン | レスポンシブデザイン対応 |
| 対応ブラウザ | Chrome、Edge、Safari最新版 |
| キーボード操作 | 主要機能はキーボードショートカット対応 |
| ヘルプ機能 | コンテキストヘルプ、操作マニュアル |
| エラーメッセージ | 分かりやすい日本語メッセージ |

## 5. インターフェース仕様

### 5.1 外部システム連携

#### 5.1.1 電子処方箋システム連携
- **プロトコル**: HTTPS + REST API
- **データ形式**: JSON
- **認証**: OAuth 2.0
- **連携内容**: 処方箋データ送信、調剤情報受信

#### 5.1.2 レセプトオンライン請求
- **プロトコル**: 専用通信プロトコル
- **データ形式**: レセプト電算処理システム形式
- **連携内容**: レセプトデータ送信、返戻データ受信

#### 5.1.3 PACS連携
- **プロトコル**: DICOM
- **連携内容**: 画像検査オーダー送信、DICOM画像受信

#### 5.1.4 検査システム連携
- **プロトコル**: HL7 v2.x
- **連携内容**: 検査オーダー送信、検査結果受信

#### 5.1.5 オンライン資格確認
- **プロトコル**: HTTPS + API
- **連携内容**: 保険資格照会、資格確認結果受信

### 5.2 医療機器連携

#### 5.2.1 バイタルサイン測定機器
- **連携方式**: Bluetooth、USB、LAN
- **データ取得**: 体温計、血圧計、SpO2モニター等から自動取得

#### 5.2.2 心電図計
- **連携方式**: LAN、USB
- **データ形式**: PDF、DICOM

## 6. データ移行計画

### 6.1 既存システムからの移行対象

| データ種別 | 移行方法 | 優先度 |
|-----------|---------|--------|
| 患者基本情報 | CSV一括インポート | 高 |
| 過去カルテ（1年分） | PDF変換+リンク | 高 |
| 処方履歴（1年分） | データ変換+インポート | 中 |
| 検査結果（1年分） | データ変換+インポート | 中 |
| 病名履歴 | ICD-10変換+インポート | 高 |
| 会計データ（当年度） | データ変換+インポート | 高 |

### 6.2 移行スケジュール

```
[3ヶ月前] データクレンジング、変換ツール開発
  ↓
[2ヶ月前] テスト環境での移行リハーサル
  ↓
[1ヶ月前] 本番環境準備、最終リハーサル
  ↓
[移行日] データ移行実施（休診日）
  ↓
[移行翌日] 検証、修正対応
  ↓
[1週間後] 安定稼働確認
```

## 7. 段階的リリース計画

### フェーズ1（MVP: 最小実行可能製品）

**実装機能**:
- F-PAT-001 患者登録・管理
- F-MED-001 受付・来院登録
- F-MED-002 カルテ記録（基本機能）
- F-ORD-001 処方オーダー（基本機能）
- F-BIL-001 会計処理（基本機能）
- F-SYS-001 ユーザー・権限管理

**目標**: 小規模クリニックでの外来診療に最低限必要な機能

### フェーズ2（機能拡充）

**追加機能**:
- F-PAT-002 アレルギー・既往歴管理
- F-ORD-002 検査オーダー
- F-APP-001 診療予約
- F-MED-003 診断・病名登録
- F-MED-004 バイタルサイン記録
- F-REP-001 各種帳票出力

**目標**: 外来診療の完全対応

### フェーズ3（入院・高度機能）

**追加機能**:
- F-ADM-001 入院管理
- F-ADM-002 看護記録
- F-ORD-003 画像検査オーダー
- F-BIL-002 レセプト請求
- F-REP-002 統計・分析

**目標**: 入院機能、高度な分析機能の提供

### フェーズ4（患者サービス）

**追加機能**:
- F-PTL-001 患者ポータル
- オンライン診療機能
- AI診断支援機能

**目標**: 患者向けサービスの充実、先進機能の提供

---

この機能概要設計は、医療現場の実務フローに基づき、段階的な導入が可能な構成としています。
