# 医療カルテシステム データモデル設計

## 1. データモデル設計方針

### 1.1 基本原則
- **正規化**: データの冗長性を排除し、整合性を保つ（第3正規形まで適用）
- **監査証跡**: 全ての重要データに作成日時・更新日時・操作者を記録
- **論理削除**: 医療データは物理削除せず、削除フラグで管理
- **履歴管理**: カルテ記録は追記型、修正履歴を完全保存
- **セキュリティ**: 個人情報は暗号化、アクセス制御を徹底

### 1.2 データ設計の課題と解決策

| 課題 | 解決策 |
|------|--------|
| カルテ記録の改ざん防止 | 履歴テーブルで全変更を記録、電子署名 |
| 同時アクセス制御 | 楽観的ロック（version番号）を使用 |
| 大量の画像データ管理 | PACS連携、BLOBは外部ストレージ |
| 複雑な検索要件 | 全文検索インデックス、適切な複合インデックス |
| 患者情報の機密性 | カラムレベル暗号化、マスキング機能 |

## 2. エンティティ一覧

### 2.1 患者管理系
1. **患者 (Patient)** - 患者の基本情報
2. **患者アレルギー情報 (PatientAllergy)** - アレルギー歴
3. **患者既往歴 (PatientMedicalHistory)** - 既往歴
4. **患者家族歴 (PatientFamilyHistory)** - 家族歴
5. **患者保険情報 (PatientInsurance)** - 保険証情報

### 2.2 診療管理系
6. **来院記録 (Visit)** - 来院・診療の基本単位
7. **カルテ (MedicalRecord)** - 診療記録の本体
8. **カルテ履歴 (MedicalRecordHistory)** - カルテ変更履歴
9. **診断情報 (Diagnosis)** - 傷病名
10. **バイタルサイン (VitalSign)** - バイタル測定値

### 2.3 オーダー管理系
11. **処方オーダー (PrescriptionOrder)** - 処方指示
12. **処方明細 (PrescriptionDetail)** - 処方薬詳細
13. **検査オーダー (LabOrder)** - 検査指示
14. **検査結果 (LabResult)** - 検査結果
15. **画像検査オーダー (ImagingOrder)** - 画像検査指示
16. **画像検査結果 (ImagingResult)** - 画像検査結果

### 2.4 入院管理系
17. **入院記録 (Admission)** - 入院情報
18. **病床管理 (Bed)** - 病床情報
19. **看護記録 (NursingRecord)** - 看護記録
20. **投薬実施記録 (MedicationAdministration)** - 投薬実施記録

### 2.5 予約・スケジュール管理系
21. **予約 (Appointment)** - 診療予約
22. **診療枠 (Schedule)** - 診療スケジュール
23. **待合状況 (WaitingQueue)** - 待合室管理

### 2.6 医事会計系
24. **会計情報 (Billing)** - 診療費会計
25. **会計明細 (BillingDetail)** - 会計明細
26. **診療報酬項目 (MedicalFeeItem)** - 診療報酬マスタ
27. **支払記録 (Payment)** - 支払情報

### 2.7 マスタ系
28. **職員 (Staff)** - 医師・看護師等の職員情報
29. **診療科 (Department)** - 診療科マスタ
30. **薬剤 (Medication)** - 薬剤マスタ
31. **検査項目 (LabTest)** - 検査項目マスタ
32. **病名 (Disease)** - 病名マスタ（ICD-10準拠）
33. **施設情報 (Facility)** - 病院・クリニック情報

### 2.8 システム管理系
34. **ユーザー (User)** - システムユーザー
35. **ロール (Role)** - 権限ロール
36. **監査ログ (AuditLog)** - 操作ログ
37. **システム設定 (SystemConfig)** - システム設定

## 3. 詳細エンティティ定義

### 3.1 患者 (Patient)

患者の基本情報を管理する中核テーブル

| カラム名 | データ型 | NULL | キー | 説明 |
|---------|---------|------|------|------|
| patient_id | BIGINT | NO | PK | 患者ID（自動採番） |
| patient_number | VARCHAR(20) | NO | UK | 患者番号（診察券番号） |
| last_name | VARCHAR(50) | NO | | 姓 |
| first_name | VARCHAR(50) | NO | | 名 |
| last_name_kana | VARCHAR(50) | NO | IDX | 姓（カナ） |
| first_name_kana | VARCHAR(50) | NO | | 名（カナ） |
| date_of_birth | DATE | NO | IDX | 生年月日 |
| gender | CHAR(1) | NO | | 性別（M/F/O） |
| blood_type | VARCHAR(5) | YES | | 血液型（A/B/O/AB, +/-） |
| postal_code | VARCHAR(10) | YES | | 郵便番号 |
| address1 | VARCHAR(100) | YES | | 住所1（都道府県・市区町村） |
| address2 | VARCHAR(100) | YES | | 住所2（番地） |
| address3 | VARCHAR(100) | YES | | 住所3（建物名等） |
| phone_number | VARCHAR(20) | YES | | 電話番号 |
| mobile_number | VARCHAR(20) | YES | | 携帯電話番号 |
| email | VARCHAR(100) | YES | | メールアドレス |
| emergency_contact_name | VARCHAR(100) | YES | | 緊急連絡先氏名 |
| emergency_contact_phone | VARCHAR(20) | YES | | 緊急連絡先電話番号 |
| emergency_contact_relation | VARCHAR(20) | YES | | 緊急連絡先続柄 |
| is_deceased | BOOLEAN | NO | | 死亡フラグ |
| date_of_death | DATE | YES | | 死亡日 |
| notes | TEXT | YES | | 備考 |
| is_deleted | BOOLEAN | NO | | 削除フラグ |
| created_at | TIMESTAMP | NO | | 作成日時 |
| created_by | BIGINT | NO | FK | 作成者（User.user_id） |
| updated_at | TIMESTAMP | NO | | 更新日時 |
| updated_by | BIGINT | NO | FK | 更新者（User.user_id） |

**制約・ルール:**
- patient_numberは施設内で一意
- 年齢は date_of_birth から計算（カラムとして保持しない）
- 個人情報（氏名、住所等）は暗号化保存推奨

### 3.2 患者アレルギー情報 (PatientAllergy)

| カラム名 | データ型 | NULL | キー | 説明 |
|---------|---------|------|------|------|
| allergy_id | BIGINT | NO | PK | アレルギー情報ID |
| patient_id | BIGINT | NO | FK | 患者ID |
| allergen_type | VARCHAR(20) | NO | | アレルゲン種類（DRUG/FOOD/OTHER） |
| allergen_name | VARCHAR(100) | NO | | アレルゲン名称 |
| medication_id | BIGINT | YES | FK | 薬剤ID（薬剤アレルギーの場合） |
| severity | VARCHAR(20) | NO | | 重症度（MILD/MODERATE/SEVERE） |
| reaction | TEXT | YES | | 反応・症状 |
| onset_date | DATE | YES | | 発症日 |
| notes | TEXT | YES | | 備考 |
| is_active | BOOLEAN | NO | | 有効フラグ |
| created_at | TIMESTAMP | NO | | 作成日時 |
| created_by | BIGINT | NO | FK | 作成者 |
| updated_at | TIMESTAMP | NO | | 更新日時 |
| updated_by | BIGINT | NO | FK | 更新者 |

**制約・ルール:**
- 患者単位で同一アレルゲンの重複登録不可
- 処方時に自動チェック対象

### 3.3 患者既往歴 (PatientMedicalHistory)

| カラム名 | データ型 | NULL | キー | 説明 |
|---------|---------|------|------|------|
| history_id | BIGINT | NO | PK | 既往歴ID |
| patient_id | BIGINT | NO | FK | 患者ID |
| disease_id | BIGINT | YES | FK | 病名ID |
| disease_name | VARCHAR(200) | NO | | 病名 |
| onset_date | DATE | YES | | 発症日 |
| resolution_date | DATE | YES | | 治癒日 |
| status | VARCHAR(20) | NO | | 状態（ACTIVE/RESOLVED/CHRONIC） |
| notes | TEXT | YES | | 備考 |
| created_at | TIMESTAMP | NO | | 作成日時 |
| created_by | BIGINT | NO | FK | 作成者 |
| updated_at | TIMESTAMP | NO | | 更新日時 |
| updated_by | BIGINT | NO | FK | 更新者 |

### 3.4 来院記録 (Visit)

診療の基本単位。外来・入院の両方を管理

| カラム名 | データ型 | NULL | キー | 説明 |
|---------|---------|------|------|------|
| visit_id | BIGINT | NO | PK | 来院ID |
| visit_number | VARCHAR(30) | NO | UK | 来院番号 |
| patient_id | BIGINT | NO | FK | 患者ID |
| visit_type | VARCHAR(20) | NO | | 来院種別（OUTPATIENT/EMERGENCY/INPATIENT） |
| visit_date | DATE | NO | IDX | 来院日 |
| visit_time | TIME | YES | | 来院時刻 |
| department_id | BIGINT | NO | FK | 診療科ID |
| attending_doctor_id | BIGINT | NO | FK | 担当医ID |
| chief_complaint | TEXT | YES | | 主訴 |
| visit_status | VARCHAR(20) | NO | | 状態（REGISTERED/EXAMINING/COMPLETED/CANCELLED） |
| admission_id | BIGINT | YES | FK | 入院記録ID（入院の場合） |
| appointment_id | BIGINT | YES | FK | 予約ID |
| completed_at | TIMESTAMP | YES | | 診療完了日時 |
| is_first_visit | BOOLEAN | NO | | 初診フラグ |
| created_at | TIMESTAMP | NO | | 作成日時 |
| created_by | BIGINT | NO | FK | 作成者 |
| updated_at | TIMESTAMP | NO | | 更新日時 |
| updated_by | BIGINT | NO | FK | 更新者 |

**制約・ルール:**
- visit_numberは日付+連番等で一意性確保
- 患者1名が同日複数診療科受診可能

### 3.5 カルテ (MedicalRecord)

診療記録の本体。SOAPフォーマットを基本とする

| カラム名 | データ型 | NULL | キー | 説明 |
|---------|---------|------|------|------|
| record_id | BIGINT | NO | PK | カルテID |
| visit_id | BIGINT | NO | FK | 来院ID |
| patient_id | BIGINT | NO | FK,IDX | 患者ID |
| record_date | TIMESTAMP | NO | IDX | 記録日時 |
| record_type | VARCHAR(20) | NO | | 記録種別（SOAP/PROGRESS/SUMMARY） |
| subjective | TEXT | YES | | S: 自覚症状（患者の訴え） |
| objective | TEXT | YES | | O: 他覚所見（検査結果等） |
| assessment | TEXT | YES | | A: 評価（診断） |
| plan | TEXT | YES | | P: 計画（治療方針） |
| free_text | TEXT | YES | | フリーテキスト |
| is_signed | BOOLEAN | NO | | 署名済みフラグ |
| signed_at | TIMESTAMP | YES | | 署名日時 |
| signed_by | BIGINT | YES | FK | 署名者ID |
| signature_data | TEXT | YES | | 電子署名データ |
| version | INT | NO | | バージョン番号（楽観的ロック用） |
| created_at | TIMESTAMP | NO | | 作成日時 |
| created_by | BIGINT | NO | FK | 作成者（医師ID） |
| updated_at | TIMESTAMP | NO | | 更新日時 |
| updated_by | BIGINT | NO | FK | 更新者 |

**制約・ルール:**
- 署名後は編集不可（新規版として保存）
- 全文検索インデックス作成推奨

### 3.6 カルテ履歴 (MedicalRecordHistory)

カルテの全変更履歴を保存（改ざん防止）

| カラム名 | データ型 | NULL | キー | 説明 |
|---------|---------|------|------|------|
| history_id | BIGINT | NO | PK | 履歴ID |
| record_id | BIGINT | NO | FK,IDX | カルテID |
| version | INT | NO | | バージョン番号 |
| operation_type | VARCHAR(20) | NO | | 操作種別（CREATE/UPDATE/DELETE） |
| record_data | JSON/TEXT | NO | | 記録データ（スナップショット） |
| changed_at | TIMESTAMP | NO | | 変更日時 |
| changed_by | BIGINT | NO | FK | 変更者ID |
| change_reason | TEXT | YES | | 変更理由 |

**制約・ルール:**
- レコードは削除不可
- 全履歴を永続保存

### 3.7 診断情報 (Diagnosis)

傷病名の記録

| カラム名 | データ型 | NULL | キー | 説明 |
|---------|---------|------|------|------|
| diagnosis_id | BIGINT | NO | PK | 診断ID |
| visit_id | BIGINT | NO | FK | 来院ID |
| patient_id | BIGINT | NO | FK,IDX | 患者ID |
| disease_id | BIGINT | YES | FK | 病名ID（マスタ） |
| disease_code | VARCHAR(20) | YES | | 病名コード（ICD-10） |
| disease_name | VARCHAR(200) | NO | | 病名 |
| diagnosis_type | VARCHAR(20) | NO | | 診断区分（MAIN/SUB/SUSPECTED） |
| onset_date | DATE | YES | | 発症日 |
| outcome | VARCHAR(20) | YES | | 転帰（CURED/IMPROVED/UNCHANGED/WORSENED/DEAD） |
| outcome_date | DATE | YES | | 転帰日 |
| is_chronic | BOOLEAN | NO | | 慢性疾患フラグ |
| notes | TEXT | YES | | 備考 |
| created_at | TIMESTAMP | NO | | 作成日時 |
| created_by | BIGINT | NO | FK | 作成者 |
| updated_at | TIMESTAMP | NO | | 更新日時 |
| updated_by | BIGINT | NO | FK | 更新者 |

### 3.8 バイタルサイン (VitalSign)

| カラム名 | データ型 | NULL | キー | 説明 |
|---------|---------|------|------|------|
| vital_id | BIGINT | NO | PK | バイタルID |
| visit_id | BIGINT | YES | FK | 来院ID |
| patient_id | BIGINT | NO | FK,IDX | 患者ID |
| measured_at | TIMESTAMP | NO | IDX | 測定日時 |
| height | DECIMAL(5,2) | YES | | 身長（cm） |
| weight | DECIMAL(5,2) | YES | | 体重（kg） |
| bmi | DECIMAL(4,2) | YES | | BMI（計算値） |
| body_temperature | DECIMAL(4,2) | YES | | 体温（℃） |
| systolic_bp | INT | YES | | 収縮期血圧（mmHg） |
| diastolic_bp | INT | YES | | 拡張期血圧（mmHg） |
| pulse_rate | INT | YES | | 脈拍（回/分） |
| respiratory_rate | INT | YES | | 呼吸数（回/分） |
| spo2 | INT | YES | | 酸素飽和度（%） |
| consciousness_level | VARCHAR(20) | YES | | 意識レベル（JCS/GCS） |
| notes | TEXT | YES | | 備考 |
| measured_by | BIGINT | NO | FK | 測定者ID |
| created_at | TIMESTAMP | NO | | 作成日時 |

**制約・ルール:**
- 異常値の自動アラート設定
- グラフ表示のため時系列データとして最適化

### 3.9 処方オーダー (PrescriptionOrder)

| カラム名 | データ型 | NULL | キー | 説明 |
|---------|---------|------|------|------|
| order_id | BIGINT | NO | PK | オーダーID |
| order_number | VARCHAR(30) | NO | UK | オーダー番号 |
| visit_id | BIGINT | NO | FK | 来院ID |
| patient_id | BIGINT | NO | FK,IDX | 患者ID |
| ordered_at | TIMESTAMP | NO | IDX | オーダー日時 |
| ordered_by | BIGINT | NO | FK | 処方医ID |
| prescription_type | VARCHAR(20) | NO | | 処方区分（INTERNAL/EXTERNAL/INJECTION） |
| usage_period_start | DATE | YES | | 用法期間開始 |
| usage_period_end | DATE | YES | | 用法期間終了 |
| status | VARCHAR(20) | NO | | ステータス（ORDERED/VERIFIED/DISPENSED/CANCELLED） |
| verified_at | TIMESTAMP | YES | | 薬剤師確認日時 |
| verified_by | BIGINT | YES | FK | 薬剤師ID |
| dispensed_at | TIMESTAMP | YES | | 調剤完了日時 |
| notes | TEXT | YES | | 備考・指示事項 |
| is_urgent | BOOLEAN | NO | | 至急フラグ |
| created_at | TIMESTAMP | NO | | 作成日時 |
| created_by | BIGINT | NO | FK | 作成者 |
| updated_at | TIMESTAMP | NO | | 更新日時 |
| updated_by | BIGINT | NO | FK | 更新者 |

### 3.10 処方明細 (PrescriptionDetail)

| カラム名 | データ型 | NULL | キー | 説明 |
|---------|---------|------|------|------|
| detail_id | BIGINT | NO | PK | 明細ID |
| order_id | BIGINT | NO | FK | オーダーID |
| medication_id | BIGINT | NO | FK | 薬剤ID |
| medication_code | VARCHAR(20) | NO | | 薬剤コード（YJコード） |
| medication_name | VARCHAR(200) | NO | | 薬剤名 |
| dosage | DECIMAL(10,3) | NO | | 1回量 |
| dosage_unit | VARCHAR(20) | NO | | 単位（錠/包/mg/ml等） |
| frequency | VARCHAR(50) | NO | | 用法（1日3回毎食後等） |
| frequency_code | VARCHAR(20) | YES | | 用法コード |
| days | INT | YES | | 日数 |
| total_quantity | DECIMAL(10,3) | NO | | 総量 |
| route | VARCHAR(20) | YES | | 投与経路（ORAL/IV/IM等） |
| instruction | TEXT | YES | | 服薬指示 |
| is_generic_allowed | BOOLEAN | NO | | ジェネリック可否 |
| created_at | TIMESTAMP | NO | | 作成日時 |
| created_by | BIGINT | NO | FK | 作成者 |

**制約・ルール:**
- 処方オーダー確定後は編集不可（取消→再発行）
- 薬剤相互作用チェック必須
- アレルギーチェック必須

### 3.11 検査オーダー (LabOrder)

| カラム名 | データ型 | NULL | キー | 説明 |
|---------|---------|------|------|------|
| order_id | BIGINT | NO | PK | オーダーID |
| order_number | VARCHAR(30) | NO | UK | オーダー番号 |
| visit_id | BIGINT | NO | FK | 来院ID |
| patient_id | BIGINT | NO | FK,IDX | 患者ID |
| ordered_at | TIMESTAMP | NO | IDX | オーダー日時 |
| ordered_by | BIGINT | NO | FK | 依頼医ID |
| test_category | VARCHAR(20) | NO | | 検査区分（BLOOD/URINE/CULTURE等） |
| specimen_collected_at | TIMESTAMP | YES | | 検体採取日時 |
| status | VARCHAR(20) | NO | | ステータス（ORDERED/COLLECTED/TESTING/COMPLETED/CANCELLED） |
| is_urgent | BOOLEAN | NO | | 至急フラグ |
| is_fasting | BOOLEAN | YES | | 絶食検査フラグ |
| notes | TEXT | YES | | 備考・依頼事項 |
| created_at | TIMESTAMP | NO | | 作成日時 |
| created_by | BIGINT | NO | FK | 作成者 |
| updated_at | TIMESTAMP | NO | | 更新日時 |
| updated_by | BIGINT | NO | FK | 更新者 |

### 3.12 検査結果 (LabResult)

| カラム名 | データ型 | NULL | キー | 説明 |
|---------|---------|------|------|------|
| result_id | BIGINT | NO | PK | 結果ID |
| order_id | BIGINT | NO | FK | オーダーID |
| test_id | BIGINT | NO | FK | 検査項目ID |
| test_code | VARCHAR(20) | NO | | 検査コード |
| test_name | VARCHAR(200) | NO | | 検査項目名 |
| result_value | VARCHAR(100) | YES | | 結果値 |
| result_numeric | DECIMAL(15,5) | YES | | 結果値（数値） |
| result_text | TEXT | YES | | 結果値（テキスト） |
| unit | VARCHAR(20) | YES | | 単位 |
| reference_range | VARCHAR(100) | YES | | 基準値範囲 |
| reference_min | DECIMAL(15,5) | YES | | 基準値下限 |
| reference_max | DECIMAL(15,5) | YES | | 基準値上限 |
| abnormal_flag | VARCHAR(10) | YES | | 異常フラグ（H/L/HH/LL） |
| result_status | VARCHAR(20) | NO | | 結果ステータス（PRELIMINARY/FINAL/CORRECTED） |
| resulted_at | TIMESTAMP | YES | | 結果確定日時 |
| verified_by | BIGINT | YES | FK | 確認者ID |
| notes | TEXT | YES | | 備考・コメント |
| created_at | TIMESTAMP | NO | | 作成日時 |
| created_by | BIGINT | NO | FK | 作成者 |

**制約・ルール:**
- 異常値は自動アラート
- 過去結果との比較表示機能

### 3.13 入院記録 (Admission)

| カラム名 | データ型 | NULL | キー | 説明 |
|---------|---------|------|------|------|
| admission_id | BIGINT | NO | PK | 入院ID |
| admission_number | VARCHAR(30) | NO | UK | 入院番号 |
| patient_id | BIGINT | NO | FK,IDX | 患者ID |
| admission_date | DATE | NO | IDX | 入院日 |
| admission_time | TIME | YES | | 入院時刻 |
| discharge_date | DATE | YES | IDX | 退院日 |
| discharge_time | TIME | YES | | 退院時刻 |
| department_id | BIGINT | NO | FK | 入院診療科ID |
| attending_doctor_id | BIGINT | NO | FK | 主治医ID |
| bed_id | BIGINT | YES | FK | 病床ID |
| admission_type | VARCHAR(20) | NO | | 入院区分（PLANNED/EMERGENCY） |
| admission_route | VARCHAR(20) | YES | | 入院経路（OUTPATIENT/EMERGENCY/TRANSFER） |
| admission_reason | TEXT | YES | | 入院理由 |
| discharge_type | VARCHAR(20) | YES | | 退院区分（NORMAL/TRANSFER/DEATH/OTHER） |
| discharge_destination | VARCHAR(100) | YES | | 退院先 |
| status | VARCHAR(20) | NO | | 状態（ADMITTED/DISCHARGED/TRANSFERRED） |
| created_at | TIMESTAMP | NO | | 作成日時 |
| created_by | BIGINT | NO | FK | 作成者 |
| updated_at | TIMESTAMP | NO | | 更新日時 |
| updated_by | BIGINT | NO | FK | 更新者 |

### 3.14 予約 (Appointment)

| カラム名 | データ型 | NULL | キー | 説明 |
|---------|---------|------|------|------|
| appointment_id | BIGINT | NO | PK | 予約ID |
| appointment_number | VARCHAR(30) | NO | UK | 予約番号 |
| patient_id | BIGINT | NO | FK,IDX | 患者ID |
| schedule_id | BIGINT | NO | FK | 診療枠ID |
| department_id | BIGINT | NO | FK | 診療科ID |
| doctor_id | BIGINT | YES | FK | 医師ID（医師指定の場合） |
| appointment_date | DATE | NO | IDX | 予約日 |
| appointment_time | TIME | NO | | 予約時間 |
| duration_minutes | INT | NO | | 予定時間（分） |
| appointment_type | VARCHAR(20) | NO | | 予約種別（FIRST/FOLLOW_UP/CHECKUP） |
| purpose | TEXT | YES | | 予約目的 |
| status | VARCHAR(20) | NO | | 状態（RESERVED/CONFIRMED/CHECKED_IN/COMPLETED/CANCELLED/NO_SHOW） |
| reservation_method | VARCHAR(20) | NO | | 予約方法（PHONE/ONLINE/COUNTER） |
| reminder_sent_at | TIMESTAMP | YES | | リマインダー送信日時 |
| cancelled_at | TIMESTAMP | YES | | キャンセル日時 |
| cancel_reason | TEXT | YES | | キャンセル理由 |
| notes | TEXT | YES | | 備考 |
| created_at | TIMESTAMP | NO | | 作成日時 |
| created_by | BIGINT | NO | FK | 作成者 |
| updated_at | TIMESTAMP | NO | | 更新日時 |
| updated_by | BIGINT | NO | FK | 更新者 |

### 3.15 会計情報 (Billing)

| カラム名 | データ型 | NULL | キー | 説明 |
|---------|---------|------|------|------|
| billing_id | BIGINT | NO | PK | 会計ID |
| billing_number | VARCHAR(30) | NO | UK | 会計番号 |
| visit_id | BIGINT | NO | FK | 来院ID |
| patient_id | BIGINT | NO | FK,IDX | 患者ID |
| billing_date | DATE | NO | IDX | 請求日 |
| insurance_id | BIGINT | YES | FK | 保険情報ID |
| insurance_type | VARCHAR(20) | NO | | 保険種別（NATIONAL/EMPLOYEE/SELF） |
| insurance_ratio | DECIMAL(3,2) | NO | | 保険負担割合（0.70/0.80/0.90） |
| total_points | INT | NO | | 診療報酬点数合計 |
| total_amount | DECIMAL(10,0) | NO | | 総額（円） |
| insurance_amount | DECIMAL(10,0) | NO | | 保険負担額（円） |
| patient_amount | DECIMAL(10,0) | NO | | 患者負担額（円） |
| payment_status | VARCHAR(20) | NO | | 支払状態（UNPAID/PAID/PARTIALLY_PAID） |
| billing_status | VARCHAR(20) | NO | | 請求ステータス（DRAFT/FINALIZED/SUBMITTED） |
| receipt_number | VARCHAR(30) | YES | | 領収書番号 |
| issued_at | TIMESTAMP | YES | | 発行日時 |
| notes | TEXT | YES | | 備考 |
| created_at | TIMESTAMP | NO | | 作成日時 |
| created_by | BIGINT | NO | FK | 作成者 |
| updated_at | TIMESTAMP | NO | | 更新日時 |
| updated_by | BIGINT | NO | FK | 更新者 |

### 3.16 職員 (Staff)

| カラム名 | データ型 | NULL | キー | 説明 |
|---------|---------|------|------|------|
| staff_id | BIGINT | NO | PK | 職員ID |
| staff_number | VARCHAR(20) | NO | UK | 職員番号 |
| user_id | BIGINT | YES | FK | ユーザーID |
| last_name | VARCHAR(50) | NO | | 姓 |
| first_name | VARCHAR(50) | NO | | 名 |
| last_name_kana | VARCHAR(50) | NO | | 姓（カナ） |
| first_name_kana | VARCHAR(50) | NO | | 名（カナ） |
| staff_type | VARCHAR(20) | NO | | 職種（DOCTOR/NURSE/PHARMACIST/TECHNICIAN/CLERK） |
| department_id | BIGINT | YES | FK | 所属診療科ID |
| license_number | VARCHAR(50) | YES | | 医師免許番号等 |
| specialties | VARCHAR(200) | YES | | 専門分野 |
| email | VARCHAR(100) | YES | | メールアドレス |
| phone_number | VARCHAR(20) | YES | | 電話番号 |
| employment_status | VARCHAR(20) | NO | | 雇用状態（ACTIVE/INACTIVE/RETIRED） |
| hire_date | DATE | YES | | 入職日 |
| resignation_date | DATE | YES | | 退職日 |
| is_deleted | BOOLEAN | NO | | 削除フラグ |
| created_at | TIMESTAMP | NO | | 作成日時 |
| created_by | BIGINT | NO | FK | 作成者 |
| updated_at | TIMESTAMP | NO | | 更新日時 |
| updated_by | BIGINT | NO | FK | 更新者 |

### 3.17 監査ログ (AuditLog)

全ての重要操作を記録

| カラム名 | データ型 | NULL | キー | 説明 |
|---------|---------|------|------|------|
| log_id | BIGINT | NO | PK | ログID |
| user_id | BIGINT | YES | FK,IDX | ユーザーID |
| staff_id | BIGINT | YES | FK,IDX | 職員ID |
| action_type | VARCHAR(50) | NO | IDX | 操作種別（LOGIN/LOGOUT/VIEW/CREATE/UPDATE/DELETE） |
| target_type | VARCHAR(50) | NO | | 対象テーブル名 |
| target_id | BIGINT | YES | IDX | 対象レコードID |
| patient_id | BIGINT | YES | FK,IDX | 患者ID（患者情報操作時） |
| action_detail | TEXT | YES | | 操作詳細 |
| ip_address | VARCHAR(45) | YES | | IPアドレス |
| user_agent | VARCHAR(255) | YES | | ユーザーエージェント |
| result | VARCHAR(20) | NO | | 結果（SUCCESS/FAILURE） |
| error_message | TEXT | YES | | エラーメッセージ |
| timestamp | TIMESTAMP | NO | IDX | 操作日時 |

**制約・ルール:**
- レコード削除不可
- 定期的なアーカイブ処理
- パフォーマンス考慮し、パーティショニング推奨

## 4. ER図（主要エンティティの関連）

```
Patient (患者)
  │
  ├──1:N─→ Visit (来院記録)
  │         │
  │         ├──1:N─→ MedicalRecord (カルテ)
  │         │         │
  │         │         └──1:N─→ MedicalRecordHistory (履歴)
  │         │
  │         ├──1:N─→ Diagnosis (診断情報)
  │         ├──1:N─→ PrescriptionOrder (処方オーダー)
  │         │         │
  │         │         └──1:N─→ PrescriptionDetail (処方明細)
  │         │
  │         ├──1:N─→ LabOrder (検査オーダー)
  │         │         │
  │         │         └──1:N─→ LabResult (検査結果)
  │         │
  │         ├──1:N─→ ImagingOrder (画像検査オーダー)
  │         └──1:1─→ Billing (会計情報)
  │                   │
  │                   └──1:N─→ BillingDetail (会計明細)
  │
  ├──1:N─→ PatientAllergy (アレルギー情報)
  ├──1:N─→ PatientMedicalHistory (既往歴)
  ├──1:N─→ PatientInsurance (保険情報)
  ├──1:N─→ Appointment (予約)
  ├──1:N─→ Admission (入院記録)
  │         │
  │         └──1:N─→ NursingRecord (看護記録)
  │
  └──1:N─→ VitalSign (バイタルサイン)

Staff (職員)
  │
  ├──1:N─→ Visit (担当医として)
  ├──1:N─→ MedicalRecord (記録者として)
  ├──1:N─→ PrescriptionOrder (処方医として)
  └──1:1─→ User (システムユーザー)

Department (診療科)
  │
  ├──1:N─→ Staff (所属職員)
  ├──1:N─→ Visit (診療科)
  └──1:N─→ Schedule (診療枠)

Medication (薬剤マスタ)
  │
  └──1:N─→ PrescriptionDetail (処方明細)

LabTest (検査項目マスタ)
  │
  └──1:N─→ LabResult (検査結果)
```

## 5. インデックス戦略

### 5.1 必須インデックス

| テーブル | カラム | 種類 | 理由 |
|---------|--------|------|------|
| Patient | patient_number | UK | 患者番号検索 |
| Patient | last_name_kana, first_name_kana | IDX | カナ検索 |
| Patient | date_of_birth | IDX | 生年月日検索 |
| Visit | patient_id, visit_date | IDX | 患者別来院履歴 |
| MedicalRecord | patient_id, record_date | IDX | 患者別カルテ検索 |
| MedicalRecord | visit_id | FK | 来院別カルテ検索 |
| Appointment | patient_id, appointment_date | IDX | 患者別予約検索 |
| Billing | patient_id, billing_date | IDX | 患者別会計検索 |
| AuditLog | user_id, timestamp | IDX | ユーザー別ログ検索 |
| AuditLog | patient_id, timestamp | IDX | 患者アクセスログ |

### 5.2 全文検索インデックス

| テーブル | カラム | 理由 |
|---------|--------|------|
| MedicalRecord | subjective, objective, assessment, plan, free_text | カルテ本文検索 |
| Diagnosis | disease_name | 病名検索 |

## 6. データ保持期間・アーカイブ戦略

| データ種別 | 保持期間 | アーカイブ方針 |
|-----------|---------|--------------|
| カルテ本体 | 永久保存 | 5年経過後は読み取り専用ストレージへ |
| 検査結果 | 永久保存 | 5年経過後は読み取り専用ストレージへ |
| 画像データ | 永久保存 | 2年経過後はアーカイブストレージへ |
| 監査ログ | 7年 | 1年経過後は別DBへパーティション移動 |
| 予約情報 | 2年 | 完了後2年でアーカイブ |
| 会計情報 | 7年（法定） | 会計年度単位でアーカイブ |

## 7. データ整合性チェック

### 7.1 必須チェック項目

1. **処方オーダー時**
   - アレルギーチェック（PatientAllergy）
   - 薬剤相互作用チェック
   - 重複投薬チェック
   - 投与量適正チェック

2. **検査オーダー時**
   - 同一検査の重複チェック
   - 禁忌チェック（腎機能等）

3. **会計処理時**
   - 診療行為と点数の整合性
   - 保険適用範囲チェック

4. **カルテ記録時**
   - 未来日の記録禁止
   - 他医師のカルテ編集禁止

### 7.2 参照整合性

全ての外部キーに対して、適切なON DELETE/ON UPDATE設定を行う。

- **ON DELETE RESTRICT**: Patient, Staff, Visit等の重要マスタ
- **ON DELETE CASCADE**: 明細データ（PrescriptionDetail等）
- **ON DELETE SET NULL**: 任意参照（Appointment.doctor_id等）

## 8. セキュリティ要件

### 8.1 暗号化対象

| データ | 暗号化方式 |
|--------|-----------|
| 患者氏名・住所 | カラムレベル暗号化（AES-256） |
| 通信 | TLS 1.3 |
| バックアップ | ディスク暗号化 |
| ログファイル | 暗号化圧縮 |

### 8.2 アクセス制御

- ロールベースアクセス制御（RBAC）
- 職種別データアクセス範囲制限
- 患者本人情報へのアクセスは監査ログ必須

## 9. パフォーマンス最適化

### 9.1 パーティショニング戦略

| テーブル | パーティション方式 | キー |
|---------|------------------|------|
| MedicalRecord | レンジパーティション | record_date（年月単位） |
| AuditLog | レンジパーティション | timestamp（月単位） |
| LabResult | レンジパーティション | resulted_at（年月単位） |
| Billing | レンジパーティション | billing_date（年単位） |

### 9.2 キャッシュ戦略

- マスタデータ（薬剤、検査項目、病名）: アプリケーションレベルキャッシュ
- 患者基本情報: セッションキャッシュ
- 直近のカルテ: Redisキャッシュ（15分TTL）

## 10. データ移行・統合考慮事項

既存システムからの移行時の考慮点：

1. **患者番号の統合**: 複数施設統合時の患者番号マッピング
2. **病名コードの統一**: ICD-10への標準化
3. **薬剤コードの統一**: YJコードへの統一
4. **過去カルテのデジタル化**: OCR+手動修正フロー
5. **データ品質チェック**: 移行前後の整合性検証

## 11. 拡張性考慮

将来的な機能拡張に備えた設計：

1. **多施設対応**: facility_idの追加
2. **多言語対応**: 翻訳テーブルの準備
3. **遠隔診療**: Visit.visit_type に TELEMEDICINE を追加
4. **AI診断支援**: 診断支援結果格納テーブルの追加
5. **ゲノム医療**: ゲノム情報テーブルの追加

---

このデータモデルは、医療情報システムの安全性に関するガイドライン（厚生労働省）および電子カルテシステム導入のベストプラクティスに基づいて設計されています。
