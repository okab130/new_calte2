# 医療カルテシステム 画面詳細設計

## 1. 画面詳細設計の範囲

本ドキュメントでは、使用頻度が高く重要な主要画面の詳細設計を記載します。

**対象画面**:
- C-001: ログイン画面
- C-003: ダッシュボード画面
- P-001: 患者検索画面
- P-002: 患者基本情報画面
- M-001: 受付画面
- M-005: カルテ記録画面（SOAP）
- O-001: 処方オーダー入力画面
- O-007: 検査結果一覧画面
- R-002: 予約受付画面
- B-001: 会計画面

---

## 2. C-001: ログイン画面

### 2.1 画面概要

| 項目 | 内容 |
|------|------|
| 画面ID | C-001 |
| 画面名 | ログイン画面 |
| 目的 | システムへの認証・ログイン |
| アクセス権限 | 全ユーザー |
| 前画面 | なし |
| 次画面 | C-003: ダッシュボード画面 |

### 2.2 画面レイアウト

```
┌─────────────────────────────────────────┐
│                                         │
│         医療カルテシステム               │
│        Electronic Medical Record        │
│                                         │
│    ┌──────────────────────────┐       │
│    │                          │       │
│    │  ユーザーID              │       │
│    │  [_________________]     │       │
│    │                          │       │
│    │  パスワード              │       │
│    │  [_________________]     │       │
│    │                          │       │
│    │  [ ] ログイン状態を保持  │       │
│    │                          │       │
│    │      [ログイン]          │       │
│    │                          │       │
│    │  パスワードを忘れた方    │       │
│    │                          │       │
│    └──────────────────────────┘       │
│                                         │
│         © 2024 Medical System           │
└─────────────────────────────────────────┘
```

### 2.3 画面項目定義

| 項目名 | 種類 | 必須 | 桁数 | 初期値 | 備考 |
|--------|------|------|------|--------|------|
| ユーザーID | テキスト | ○ | 20 | - | 半角英数字 |
| パスワード | パスワード | ○ | 8～128 | - | マスク表示 |
| ログイン状態を保持 | チェックボックス | - | - | OFF | セッション保持 |
| ログインボタン | ボタン | - | - | - | Enter キーでも実行可 |

### 2.4 処理フロー

```
[ログインボタン押下]
  ↓
[入力チェック]
  ├─ NG → エラーメッセージ表示
  ↓
[認証処理]
  ├─ ID/パスワード照合
  ├─ アカウントロック確認
  └─ 二要素認証（設定時）
  ↓
[認証成功]
  ├─ セッション発行
  ├─ 監査ログ記録（ログイン成功）
  └─ ダッシュボード画面へ遷移
  
[認証失敗]
  ├─ 失敗回数カウント
  ├─ 監査ログ記録（ログイン失敗）
  └─ エラーメッセージ表示
```

### 2.5 バリデーション

| 項目 | チェック内容 | エラーメッセージ |
|------|-------------|-----------------|
| ユーザーID | 未入力 | ユーザーIDを入力してください |
| パスワード | 未入力 | パスワードを入力してください |
| 認証 | 認証失敗 | ユーザーIDまたはパスワードが正しくありません |
| アカウント | ロック中 | アカウントがロックされています。管理者に連絡してください |

### 2.6 セキュリティ対策

- パスワードは暗号化通信（TLS 1.3）
- ログイン失敗5回でアカウントロック（30分間）
- セッションタイムアウト: 30分（無操作時）
- CSRF対策トークン使用

---

## 3. C-003: ダッシュボード画面

### 3.1 画面概要

| 項目 | 内容 |
|------|------|
| 画面ID | C-003 |
| 画面名 | ダッシュボード画面 |
| 目的 | 当日の予定、アラート、クイックアクセス表示 |
| アクセス権限 | 全ユーザー |
| 前画面 | C-001: ログイン画面 |

### 3.2 画面レイアウト

```
┌─────────────────────────────────────────────────────────┐
│ ヘッダー [医療カルテシステム]   山田医師 様  [ログアウト]│
├─────────────────────────────────────────────────────────┤
│ホーム│患者│診療│オーダー│予約│会計│レポート│設定│      │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  ┌────────────────┐  ┌─────────────────────┐       │
│  │ 本日の予定      │  │ アラート・通知       │       │
│  ├────────────────┤  ├─────────────────────┤       │
│  │ 外来患者: 25名  │  │ ⚠ 検査結果異常: 3件 │       │
│  │ 予約患者: 20名  │  │ ⚠ 処方要確認: 2件   │       │
│  │ 入院患者: 10名  │  │ 📧 新着メッセージ: 5件│      │
│  └────────────────┘  └─────────────────────┘       │
│                                                         │
│  ┌──────────────────────────────────────────┐       │
│  │ 本日の予約患者                            │       │
│  ├──────┬────┬──────┬──────┬────────┤       │
│  │ 時刻  │患者番号│氏名   │診療科 │状態    │       │
│  ├──────┼────┼──────┼──────┼────────┤       │
│  │ 09:00 │000123│山田太郎│内科   │受付済  │       │
│  │ 09:30 │000456│佐藤花子│内科   │未受付  │       │
│  │ 10:00 │000789│鈴木一郎│内科   │未受付  │       │
│  └──────┴────┴──────┴──────┴────────┘       │
│                                                         │
│  ┌─────────────┐  ┌─────────────────┐        │
│  │ クイックアクセス │  │ 統計情報           │        │
│  ├─────────────┤  ├─────────────────┤        │
│  │ [患者検索]      │  │ 本日受付患者: 15名 │        │
│  │ [カルテ記録]    │  │ 本日会計: 12件     │        │
│  │ [処方オーダー]  │  │ 月間患者数: 650名  │        │
│  │ [検査オーダー]  │  └─────────────────┘        │
│  │ [予約受付]      │                                 │
│  └─────────────┘                                 │
└─────────────────────────────────────────────────────────┘
```

### 3.3 表示項目（ロール別）

| 項目 | 医師 | 看護師 | 事務 | 薬剤師 | 検査技師 |
|------|-----|--------|------|--------|---------|
| 本日の予定 | ○ | ○ | ○ | ○ | ○ |
| アラート・通知 | ○ | ○ | ○ | ○ | ○ |
| 本日の予約患者 | ○ | ○ | ○ | - | - |
| クイックアクセス | ○ | ○ | ○ | ○ | ○ |
| 統計情報 | ○ | △ | ○ | - | - |

### 3.4 処理仕様

#### 3.4.1 アラート表示ルール

| アラート種別 | 表示条件 | 優先度 |
|-------------|---------|--------|
| 検査結果異常 | 異常値フラグ（H/L/HH/LL）がある検査結果 | 高 |
| 処方要確認 | 薬剤師未確認の処方オーダー | 中 |
| 予約遅延 | 予約時刻から30分経過しても未受付 | 中 |
| システムメンテナンス | 予定メンテナンス24時間前 | 低 |

---

## 4. P-001: 患者検索画面

### 4.1 画面概要

| 項目 | 内容 |
|------|------|
| 画面ID | P-001 |
| 画面名 | 患者検索画面 |
| 目的 | 患者の検索・選択 |
| アクセス権限 | 医師、看護師、事務、薬剤師、検査技師 |

### 4.2 画面レイアウト

```
┌─────────────────────────────────────────────────────────┐
│ 患者検索                                                 │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  検索条件                                               │
│  ┌──────────────────────────────────────────┐       │
│  │ 患者番号: [__________]                   │       │
│  │                                          │       │
│  │ 氏名カナ: [__________] [__________]      │       │
│  │           （姓）        （名）           │       │
│  │                                          │       │
│  │ 生年月日: [____]/[__]/[__]               │       │
│  │           （年） （月）（日）            │       │
│  │                                          │       │
│  │ 電話番号: [_____________]                │       │
│  │                                          │       │
│  │        [検索]  [クリア]                  │       │
│  └──────────────────────────────────────────┘       │
│                                                         │
│  検索結果: 10件                                         │
│  ┌──────────────────────────────────────────┐       │
│  │患者番号│氏名      │カナ      │生年月日 │性別│年齢││
│  ├──────┼──────────┼──────────┼─────────┼────┼────┤│
│  │000001 │山田 太郎 │ヤマダ タロウ│1980/01/01│男 │44 ││
│  │000002 │佐藤 花子 │サトウ ハナコ│1975/05/15│女 │49 ││
│  │000003 │鈴木 一郎 │スズキ イチロウ│1990/03/20│男│34 ││
│  │...                                              ││
│  └──────────────────────────────────────────┘       │
│                                                         │
│                    [新規患者登録]                       │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

### 4.3 検索仕様

| 検索項目 | 検索方式 | 備考 |
|---------|---------|------|
| 患者番号 | 完全一致 | ハイフン無視 |
| 氏名カナ | 前方一致 | 姓・名それぞれ独立 |
| 生年月日 | 完全一致 | 年のみ、年月のみも可 |
| 電話番号 | 部分一致 | ハイフン無視 |

### 4.4 バリデーション

- 検索条件未入力の場合、エラー「検索条件を1つ以上入力してください」
- 検索結果が100件を超える場合、警告「検索結果が多すぎます。条件を絞り込んでください」

### 4.5 操作フロー

```
[検索ボタン押下]
  ↓
[入力チェック]
  ↓
[検索実行]
  ├─ 監査ログ記録（患者検索）
  └─ 検索結果表示
  ↓
[患者選択]
  ├─ 監査ログ記録（患者情報閲覧）
  └─ P-002: 患者基本情報画面へ遷移
```

---

## 5. M-005: カルテ記録画面（SOAP）

### 5.1 画面概要

| 項目 | 内容 |
|------|------|
| 画面ID | M-005 |
| 画面名 | カルテ記録画面（SOAP） |
| 目的 | 診療記録の入力 |
| アクセス権限 | 医師 |

### 5.2 画面レイアウト

```
┌─────────────────────────────────────────────────────────┐
│ カルテ記録 - 山田 太郎（男性・44歳）患者番号: 000001    │
├─────────────────────────────────────────────────────────┤
│ [患者情報] [アレルギー⚠] [既往歴] [処方履歴] [検査結果]│
├─────────────────────────────────────────────────────────┤
│                                                         │
│  記録日時: 2024/01/15 10:30    記録者: 山田医師        │
│                                                         │
│  ┌─ S: Subjective（自覚症状・主訴）────────────┐    │
│  │                                              │    │
│  │ [テンプレート▼] [音声入力🎤]                 │    │
│  │ ┌──────────────────────────────────┐    │    │
│  │ │3日前より咳嗽、発熱あり。               │    │    │
│  │ │昨夜より38度台の発熱継続。              │    │    │
│  │ │                                        │    │    │
│  │ │                                        │    │    │
│  │ └──────────────────────────────────┘    │    │
│  └──────────────────────────────────────┘    │
│                                                         │
│  ┌─ O: Objective（他覚所見）────────────────┐    │
│  │ ┌──────────────────────────────────┐    │    │
│  │ │BT 38.2℃ BP 120/80 PR 82                │    │    │
│  │ │咽頭発赤(+) 扁桃腫大(+)                 │    │    │
│  │ │肺音: 清                                │    │    │
│  │ │                                        │    │    │
│  │ └──────────────────────────────────┘    │    │
│  └──────────────────────────────────────┘    │
│                                                         │
│  ┌─ A: Assessment（評価・診断）─────────────┐    │
│  │ ┌──────────────────────────────────┐    │    │
│  │ │急性上気道炎                            │    │    │
│  │ │                                        │    │    │
│  │ └──────────────────────────────────┘    │    │
│  │ [病名登録]                                  │    │
│  └──────────────────────────────────────┘    │
│                                                         │
│  ┌─ P: Plan（計画・治療方針）───────────────┐    │
│  │ ┌──────────────────────────────────┐    │    │
│  │ │対症療法                                │    │    │
│  │ │解熱鎮痛剤、抗生剤投与                  │    │    │
│  │ │3日後再診指示                           │    │    │
│  │ │                                        │    │    │
│  │ └──────────────────────────────────┘    │    │
│  │ [処方オーダー] [検査オーダー] [次回予約]    │    │
│  └──────────────────────────────────────┘    │
│                                                         │
│         [一時保存]  [署名して確定]  [キャンセル]       │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

### 5.3 機能仕様

#### 5.3.1 テンプレート機能

- 医師ごとに定型文を登録可能
- 診療科別のテンプレート提供
- テンプレート選択で各項目に自動入力

#### 5.3.2 音声入力機能

- ブラウザのWeb Speech API使用
- 句読点の自動挿入
- 医学用語の辞書対応

#### 5.3.3 電子署名機能

- 「署名して確定」ボタン押下で電子署名
- 署名後は編集不可（履歴として保存）
- 修正する場合は新規版として作成

### 5.4 バリデーション

| 項目 | チェック内容 | エラーメッセージ |
|------|-------------|-----------------|
| SOAP全体 | S/O/A/Pいずれかに入力必須 | カルテ内容を入力してください |
| 署名 | 未入力での署名不可 | カルテ内容が入力されていません |

### 5.5 処理フロー

```
[一時保存]
  ↓
[入力チェック]
  ↓
[MedicalRecordテーブルに保存]
  ├─ is_signed = FALSE
  ├─ version インクリメント
  └─ 監査ログ記録
  
[署名して確定]
  ↓
[入力チェック]
  ↓
[電子署名処理]
  ├─ MedicalRecordテーブル更新
  │   ├─ is_signed = TRUE
  │   ├─ signed_at = 現在日時
  │   ├─ signed_by = ログインユーザーID
  │   └─ signature_data = 署名データ
  ├─ MedicalRecordHistoryテーブルに履歴保存
  └─ 監査ログ記録
```

---

## 6. O-001: 処方オーダー入力画面

### 6.1 画面概要

| 項目 | 内容 |
|------|------|
| 画面ID | O-001 |
| 画面名 | 処方オーダー入力画面 |
| 目的 | 処方箋の作成 |
| アクセス権限 | 医師 |

### 6.2 画面レイアウト

```
┌─────────────────────────────────────────────────────────┐
│ 処方オーダー - 山田 太郎（男性・44歳）患者番号: 000001  │
├─────────────────────────────────────────────────────────┤
│ [アレルギー情報⚠] [処方履歴] [お薬手帳]                │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  ⚠ アレルギー: ペニシリン系抗生剤（アナフィラキシー） │
│                                                         │
│  処方区分: (●)院外処方  ( )院内処方  ( )注射          │
│                                                         │
│  ┌─ 処方内容 ─────────────────────────────┐       │
│  │ [セット処方▼] [薬剤検索🔍]                  │       │
│  │                                            │       │
│  │ 1. カロナール錠200mg                       │ [削除]│
│  │    1回量: 1錠  用法: 1日3回毎食後          │       │
│  │    日数: 3日分  総量: 9錠                  │       │
│  │                                            │       │
│  │ 2. アモキシシリンカプセル250mg  ⚠アレルギー│ [削除]│
│  │    1回量: 1カプセル  用法: 1日3回毎食後    │       │
│  │    日数: 5日分  総量: 15カプセル           │       │
│  │                                            │       │
│  │ [薬剤追加]                                 │       │
│  └────────────────────────────────────┘       │
│                                                         │
│  ┌─ チェック結果 ─────────────────────────┐       │
│  │ ⚠ 警告: アモキシシリンはアレルギー情報に   │       │
│  │         該当します。投与を続けますか?       │       │
│  │                                            │       │
│  │ ℹ 情報: 同効薬の重複はありません           │       │
│  │ ℹ 情報: 薬剤相互作用は検出されませんでした │       │
│  └────────────────────────────────────┘       │
│                                                         │
│  備考・指示事項:                                       │
│  ┌──────────────────────────────────────┐       │
│  │ 発熱時のみ服用可                           │       │
│  └──────────────────────────────────────┘       │
│                                                         │
│         [処方箋プレビュー]  [オーダー]  [キャンセル]   │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

### 6.3 自動チェック機能

#### 6.3.1 アレルギーチェック

- PatientAllergyテーブルと照合
- アレルギー該当時は赤色警告表示
- 音声アラート発報
- 医師による確認必須（確認ダイアログ表示）

#### 6.3.2 薬剤相互作用チェック

- 処方中の薬剤同士の相互作用チェック
- 併用禁忌: エラー（処方不可）
- 併用注意: 警告（医師確認で処方可）

#### 6.3.3 重複投薬チェック

- 同効薬の重複チェック
- 同一成分の重複チェック
- 重複時は警告表示

#### 6.3.4 投与量適正チェック

- 年齢・体重に応じた投与量チェック
- 上限・下限を超える場合は警告

### 6.4 セット処方機能

- 医師ごとに定型処方パターンを登録
- セット選択で一括入力
- セット内容の個別編集可能

### 6.5 処理フロー

```
[オーダーボタン押下]
  ↓
[入力チェック]
  ├─ 処方内容の必須チェック
  └─ アレルギーチェック
      ├─ 該当あり → 確認ダイアログ
      │             ├─ キャンセル → 処理中断
      │             └─ 続行 → 次へ
      └─ 該当なし → 次へ
  ↓
[薬剤相互作用チェック]
  ├─ 併用禁忌 → エラー表示、処理中断
  ├─ 併用注意 → 警告表示、確認ダイアログ
  └─ 問題なし → 次へ
  ↓
[PrescriptionOrderテーブルに保存]
  ├─ order_id 発行
  ├─ status = 'ORDERED'
  └─ PrescriptionDetailテーブルに明細保存
  ↓
[薬剤部に通知]
  ↓
[監査ログ記録]
  ↓
[完了メッセージ表示]
```

---

## 7. B-001: 会計画面

### 7.1 画面概要

| 項目 | 内容 |
|------|------|
| 画面ID | B-001 |
| 画面名 | 会計画面 |
| 目的 | 診療費の計算・会計処理 |
| アクセス権限 | 医療事務 |

### 7.2 画面レイアウト

```
┌─────────────────────────────────────────────────────────┐
│ 会計処理 - 山田 太郎（男性・44歳）患者番号: 000001      │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  来院日: 2024/01/15    診療科: 内科    担当医: 山田医師│
│  保険種別: 社会保険（本人）  負担割合: 3割             │
│                                                         │
│  ┌─ 診療内容 ─────────────────────────────┐       │
│  │項目           │点数  │回数│金額      │       │       │
│  ├──────────────┼──────┼────┼──────────┤       │
│  │初診料         │  288 │ 1  │   2,880円│       │       │
│  │処方箋料       │   68 │ 1  │     680円│       │       │
│  │投薬料（内服） │   42 │ 1  │     420円│       │       │
│  │薬剤料         │   85 │ 1  │     850円│       │       │
│  │検査料（血液） │  150 │ 1  │   1,500円│       │       │
│  └──────────────┴──────┴────┴──────────┘       │
│                                                         │
│  ┌─ 会計サマリー ─────────────────────────┐       │
│  │                                            │       │
│  │  診療報酬点数合計:        633点            │       │
│  │  診療費合計:          6,330円              │       │
│  │                                            │       │
│  │  保険負担額（7割）:   4,431円              │       │
│  │  患者負担額（3割）:   1,899円              │       │
│  │                      ≒ 1,900円（10円未満四捨五入）│
│  │                                            │       │
│  │  ━━━━━━━━━━━━━━━━━━━            │       │
│  │  請求金額:            1,900円              │       │
│  │                                            │       │
│  └────────────────────────────────┘       │
│                                                         │
│  支払方法: (●)現金  ( )クレジットカード  ( )QR決済    │
│                                                         │
│  預かり金額: [________]円                              │
│  お釣り:     [________]円                              │
│                                                         │
│       [領収書発行]  [会計確定]  [キャンセル]           │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

### 7.3 自動計算仕様

#### 7.3.1 診療報酬点数計算

以下の情報から自動計算:
- 診療行為（初診・再診、処方、検査等）
- 診療報酬マスタ（MedicalFeeItem）の点数
- 加算項目（時間外加算、休日加算等）

#### 7.3.2 金額計算

```
診療費合計 = 診療報酬点数合計 × 10円

保険負担額 = 診療費合計 × 保険負担割合（0.7/0.8/0.9）
患者負担額 = 診療費合計 × (1 - 保険負担割合)

※患者負担額は10円未満四捨五入
```

### 7.4 処理フロー

```
[会計画面表示]
  ↓
[診療内容取得]
  ├─ Visit情報取得
  ├─ 診療行為情報取得
  ├─ 処方オーダー情報取得
  └─ 検査オーダー情報取得
  ↓
[診療報酬点数自動計算]
  ↓
[保険負担額・患者負担額計算]
  ↓
[画面表示]
  
[会計確定ボタン押下]
  ↓
[入力チェック]
  ↓
[Billingテーブルに保存]
  ├─ billing_id 発行
  ├─ payment_status = 'PAID'
  └─ BillingDetailテーブルに明細保存
  ↓
[Paymentテーブルに支払記録]
  ↓
[Visit.visit_status を 'COMPLETED' に更新]
  ↓
[監査ログ記録]
  ↓
[領収書発行画面へ遷移]
```

---

## 8. 共通UI部品

### 8.1 日付入力コンポーネント

- カレンダーピッカー
- 和暦・西暦切替
- 年齢自動計算（生年月日入力時）

### 8.2 患者選択コンポーネント

- オートコンプリート機能
- 患者番号または氏名カナで検索
- 検索結果のドロップダウン表示

### 8.3 薬剤検索コンポーネント

- インクリメンタルサーチ
- 薬剤名・成分名・YJコードで検索
- セット処方の選択肢表示

### 8.4 確認ダイアログ

- 重要な操作時の確認ダイアログ表示
- Yes/Noボタン
- デフォルトフォーカスはNoボタン

### 8.5 アラート表示

- 成功: 緑色背景
- 警告: 黄色背景
- エラー: 赤色背景
- 情報: 青色背景

---

## 9. アクセシビリティ対応

### 9.1 キーボード操作

- Tabキーでフォーカス移動
- Enterキーで確定
- Escキーでキャンセル
- ショートカットキー対応

### 9.2 スクリーンリーダー対応

- WAI-ARIA準拠
- 適切なラベル付け
- フォーカス順序の最適化

### 9.3 色覚対応

- 色だけで情報を伝えない
- テキストでも情報提供
- コントラスト比4.5:1以上

---

## 10. エラーハンドリング

### 10.1 入力エラー

- リアルタイムバリデーション
- エラー箇所の赤枠表示
- 具体的なエラーメッセージ

### 10.2 システムエラー

- ユーザーフレンドリーなメッセージ
- エラーコード表示
- サポート連絡先表示
- 監査ログへのエラー記録

### 10.3 ネットワークエラー

- 自動リトライ（3回まで）
- オフライン時の通知
- データ損失防止（ローカル一時保存）

---

この画面詳細設計により、医療現場で求められる使いやすさ、安全性、効率性を実現します。
